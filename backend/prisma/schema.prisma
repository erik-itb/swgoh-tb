// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Management
model User {
  id           Int       @id @default(autoincrement())
  username     String    @unique @db.VarChar(50)
  email        String    @unique @db.VarChar(255)
  passwordHash String    @map("password_hash") @db.VarChar(255)
  role         UserRole  @default(VIEWER)
  discordId    String?   @map("discord_id") @db.VarChar(100)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  lastLogin    DateTime? @map("last_login") @db.Timestamptz
  isActive     Boolean   @default(true) @map("is_active")

  // Relations
  createdSquads               Squad[]
  submittedRecommendations    MissionSquadRecommendation[] @relation("SubmittedBy")
  approvedRecommendations     MissionSquadRecommendation[] @relation("ApprovedBy")
  submittedVideos             StrategyVideo[]              @relation("VideoSubmittedBy")
  approvedVideos              StrategyVideo[]              @relation("VideoApprovedBy")
  auditLogs                   AuditLog[]

  @@map("users")
}

enum UserRole {
  VIEWER
  CONTRIBUTOR
  ADMIN
  SUPER_ADMIN

  @@map("user_role")
}

// Territory Battle Structure
model TerritoryBattle {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(100)
  slug        String   @unique @db.VarChar(100)
  description String?
  totalPhases Int      @default(6) @map("total_phases")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  phases Phase[]

  @@map("territory_battles")
}

// Phases (6 phases total)
model Phase {
  id                   Int     @id @default(autoincrement())
  territoryBattleId    Int     @map("territory_battle_id")
  phaseNumber          Int     @map("phase_number")
  name                 String? @db.VarChar(100)
  relicRequirement     String? @map("relic_requirement") @db.VarChar(20)
  startGpRequirement   BigInt? @map("start_gp_requirement")
  createdAt            DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  territoryBattle TerritoryBattle @relation(fields: [territoryBattleId], references: [id])
  planets         Planet[]

  @@unique([territoryBattleId, phaseNumber])
  @@map("phases")
}

// Planets
model Planet {
  id                 Int         @id @default(autoincrement())
  phaseId            Int         @map("phase_id")
  name               String      @db.VarChar(100)
  slug               String      @db.VarChar(100)
  alignment          Alignment
  isBonusPlanet      Boolean     @default(false) @map("is_bonus_planet")
  unlockRequirement  String?     @map("unlock_requirement")
  starRequirements   Json        @default("{}") @map("star_requirements") @db.JsonB
  backgroundImageUrl String?     @map("background_image_url")
  iconUrl            String?     @map("icon_url")
  createdAt          DateTime    @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  phase    Phase           @relation(fields: [phaseId], references: [id])
  missions CombatMission[]

  @@map("planets")
}

enum Alignment {
  DARK_SIDE
  LIGHT_SIDE
  MIXED

  @@map("alignment")
}

// Combat Missions
model CombatMission {
  id              Int            @id @default(autoincrement())
  planetId        Int            @map("planet_id")
  name            String         @db.VarChar(100)
  missionType     MissionType?   @map("mission_type")
  combatType      CombatType?    @map("combat_type")
  waveCount       Int            @default(1) @map("wave_count")
  requiredUnits   Json           @default("[]") @map("required_units") @db.JsonB
  requiredFactions String[]      @map("required_factions")
  unitCount       Int            @default(5) @map("unit_count")
  modifiers       Json           @default("[]") @db.JsonB
  rewards         Json           @default("{}") @db.JsonB
  territoryPoints Int?           @map("territory_points")
  difficultyLevel Int?           @map("difficulty_level")
  createdAt       DateTime       @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime       @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  planet          Planet                       @relation(fields: [planetId], references: [id])
  recommendations MissionSquadRecommendation[]
  waves           MissionWave[]
  videos          StrategyVideo[]

  @@map("combat_missions")
}

enum MissionType {
  COMBAT
  SPECIAL
  FLEET
  OPERATIONS

  @@map("mission_type")
}

enum CombatType {
  REGULAR
  FLEET

  @@map("combat_type")
}

// Units/Characters
model Unit {
  id          Int       @id @default(autoincrement())
  gameId      String    @unique @map("game_id") @db.VarChar(100)
  name        String    @db.VarChar(100)
  unitType    UnitType? @map("unit_type")
  alignment   Alignment?
  factions    String[]
  tags        String[]
  portraitUrl String?   @map("portrait_url")
  iconUrl     String?   @map("icon_url")
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  squadUnits SquadUnit[]

  @@map("units")
}

enum UnitType {
  CHARACTER
  SHIP
  CAPITAL_SHIP

  @@map("unit_type")
}

// Squad Compositions
model Squad {
  id                      Int        @id @default(autoincrement())
  name                    String     @db.VarChar(100)
  slug                    String?    @unique @db.VarChar(100)
  description             String?
  squadType               SquadType? @map("squad_type")
  strategyNotes           String?    @map("strategy_notes")
  minPowerRequirement     Int?       @map("min_power_requirement")
  recommendedGearTier     Int?       @map("recommended_gear_tier")
  recommendedRelicLevel   Int?       @map("recommended_relic_level")
  createdBy               Int?       @map("created_by")
  isPublished             Boolean    @default(false) @map("is_published")
  createdAt               DateTime   @default(now()) @map("created_at") @db.Timestamptz
  updatedAt               DateTime   @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  creator         User?                        @relation(fields: [createdBy], references: [id])
  units           SquadUnit[]
  recommendations MissionSquadRecommendation[]
  videos          StrategyVideo[]

  @@map("squads")
}

enum SquadType {
  REGULAR
  FLEET

  @@map("squad_type")
}

// Squad Units (many-to-many)
model SquadUnit {
  id         Int     @id @default(autoincrement())
  squadId    Int     @map("squad_id")
  unitId     Int     @map("unit_id")
  position   Int?
  isLeader   Boolean @default(false) @map("is_leader")
  isRequired Boolean @default(true) @map("is_required")
  notes      String?

  // Relations
  squad Squad @relation(fields: [squadId], references: [id], onDelete: Cascade)
  unit  Unit  @relation(fields: [unitId], references: [id])

  @@unique([squadId, position])
  @@unique([squadId, unitId])
  @@map("squad_units")
}

// Mission Squad Recommendations (with versioning)
model MissionSquadRecommendation {
  id              Int       @id @default(autoincrement())
  missionId       Int       @map("mission_id")
  squadId         Int       @map("squad_id")
  version         Int       @default(1)
  isCurrent       Boolean   @default(true) @map("is_current")
  effectiveFrom   DateTime  @default(now()) @map("effective_from") @db.Timestamptz
  priority        Int       @default(1)
  successRate     Decimal?  @map("success_rate") @db.Decimal(5, 2)
  difficultyRating Int?     @map("difficulty_rating")
  submittedBy     Int?      @map("submitted_by")
  approvedBy      Int?      @map("approved_by")
  approvedAt      DateTime? @map("approved_at") @db.Timestamptz
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  mission     CombatMission @relation(fields: [missionId], references: [id])
  squad       Squad         @relation(fields: [squadId], references: [id])
  submitter   User?         @relation("SubmittedBy", fields: [submittedBy], references: [id])
  approver    User?         @relation("ApprovedBy", fields: [approvedBy], references: [id])

  @@map("mission_squad_recommendations")
}

// Wave Information
model MissionWave {
  id                 Int      @id @default(autoincrement())
  missionId          Int      @map("mission_id")
  waveNumber         Int      @map("wave_number")
  enemies            Json     @default("[]") @db.JsonB
  specialMechanics   String[] @map("special_mechanics")
  turnMeterPreload   Int?     @map("turn_meter_preload")
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  mission CombatMission @relation(fields: [missionId], references: [id])

  @@unique([missionId, waveNumber])
  @@map("mission_waves")
}

// Strategy Videos
model StrategyVideo {
  id                Int       @id @default(autoincrement())
  missionId         Int?      @map("mission_id")
  squadId           Int?      @map("squad_id")
  title             String    @db.VarChar(200)
  description       String?
  videoUrl          String    @map("video_url") @db.VarChar(500)
  thumbnailUrl      String?   @map("thumbnail_url") @db.VarChar(500)
  platform          Platform?
  durationSeconds   Int?      @map("duration_seconds")
  creatorName       String?   @map("creator_name") @db.VarChar(100)
  creatorChannelUrl String?   @map("creator_channel_url") @db.VarChar(500)
  viewCount         Int       @default(0) @map("view_count")
  upvotes           Int       @default(0)
  downvotes         Int       @default(0)
  isFeatured        Boolean   @default(false) @map("is_featured")
  isActive          Boolean   @default(true) @map("is_active")
  submittedBy       Int?      @map("submitted_by")
  approvedBy        Int?      @map("approved_by")
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  mission   CombatMission? @relation(fields: [missionId], references: [id])
  squad     Squad?         @relation(fields: [squadId], references: [id])
  submitter User?          @relation("VideoSubmittedBy", fields: [submittedBy], references: [id])
  approver  User?          @relation("VideoApprovedBy", fields: [approvedBy], references: [id])

  @@map("strategy_videos")
}

enum Platform {
  YOUTUBE
  TWITCH

  @@map("platform")
}

// Audit Log
model AuditLog {
  id            BigInt   @id @default(autoincrement())
  tableName     String   @map("table_name") @db.VarChar(50)
  recordId      Int?     @map("record_id")
  action        String   @db.VarChar(20)
  oldValues     Json?    @map("old_values") @db.JsonB
  newValues     Json?    @map("new_values") @db.JsonB
  changedFields String[] @map("changed_fields")
  userId        Int?     @map("user_id")
  ipAddress     String?  @map("ip_address") @db.Inet
  userAgent     String?  @map("user_agent")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  user User? @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}

// Create performance indexes
// Note: These are handled in migration files