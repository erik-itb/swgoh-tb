name: Sync SWGoH GameData

on:
  schedule:
    # Run daily at 6 AM UTC (after typical game updates)
    - cron: '0 6 * * *'
  workflow_dispatch:  # Allow manual trigger
    inputs:
      force_update:
        description: 'Force update even if no changes detected'
        required: false
        default: 'false'
        type: boolean

jobs:
  sync-gamedata:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: tb_tracker
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/tb_tracker
      NODE_ENV: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            backend/package-lock.json

      - name: Install dependencies
        run: |
          npm ci
          cd backend && npm ci

      - name: Setup database schema
        run: |
          cd backend
          npx prisma db push
          npx prisma generate

      - name: Check for gamedata updates
        id: check-updates
        run: |
          # Download current version info
          mkdir -p data/temp
          curl -s https://raw.githubusercontent.com/swgoh-utils/gamedata/main/units.json | jq -r '.version' > data/temp/remote_version.txt
          
          # Check if we have existing data
          if [ -f "data/gamedata/_download_metadata.json" ]; then
            LOCAL_VERSION=$(jq -r '.results[] | select(.filename == "units.json") | .version' data/gamedata/_download_metadata.json)
            REMOTE_VERSION=$(cat data/temp/remote_version.txt)
            
            echo "Local version: $LOCAL_VERSION"
            echo "Remote version: $REMOTE_VERSION"
            
            if [ "$LOCAL_VERSION" = "$REMOTE_VERSION" ] && [ "${{ inputs.force_update }}" != "true" ]; then
              echo "needs_update=false" >> $GITHUB_OUTPUT
              echo "No update needed - versions match"
            else
              echo "needs_update=true" >> $GITHUB_OUTPUT
              echo "Update needed - versions differ or forced"
            fi
          else
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "Update needed - no local data found"
          fi

      - name: Sync gamedata
        if: steps.check-updates.outputs.needs_update == 'true'
        run: |
          echo "üöÄ Starting gamedata sync..."
          ./scripts/sync-gamedata.sh

      - name: Get sync results
        if: steps.check-updates.outputs.needs_update == 'true'
        id: sync-results
        run: |
          cd scripts/gamedata-import
          RESULTS=$(npx tsx check-import-results.ts)
          echo "sync_results<<EOF" >> $GITHUB_OUTPUT
          echo "$RESULTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create commit with updated data
        if: steps.check-updates.outputs.needs_update == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Add the data files
          git add data/gamedata/
          
          # Create commit with sync results
          COMMIT_MSG="chore: update gamedata $(date '+%Y-%m-%d %H:%M:%S UTC')

          Automated sync of SWGoH gamedata from swgoh-utils/gamedata repository.
          
          ${{ steps.sync-results.outputs.sync_results }}"
          
          git commit -m "$COMMIT_MSG" || echo "No changes to commit"

      - name: Push changes
        if: steps.check-updates.outputs.needs_update == 'true'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main

      - name: Notify on success
        if: steps.check-updates.outputs.needs_update == 'true' && success()
        run: |
          echo "‚úÖ GameData sync completed successfully!"
          echo "üìä Results: ${{ steps.sync-results.outputs.sync_results }}"

      - name: Notify on failure  
        if: failure()
        run: |
          echo "‚ùå GameData sync failed!"
          echo "Check the logs for details."