name: Weekly Asset Update

on:
  schedule:
    # Every Monday at 2 AM UTC
    - cron: '0 2 * * 1'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update all assets'
        required: false
        default: 'false'
        type: boolean
      target_environment:
        description: 'Target environment'
        required: false
        default: 'production'
        type: choice
        options:
          - staging
          - production

env:
  NODE_VERSION: '18'
  ASSET_CACHE_RETENTION: '7d'

jobs:
  asset-update:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd tools/asset-processor && npm ci

      - name: Start swgoh-ae2 service
        run: |
          docker run -d \
            --name swgoh-ae2-ci \
            -p 3001:8080 \
            ghcr.io/swgoh-utils/swgoh-ae2:latest

          # Wait for service to be ready
          timeout 60 bash -c 'until curl -f http://localhost:3001/health; do sleep 2; done'

      - name: Download latest gamedata
        run: |
          cd tools/asset-processor
          node download-gamedata.js

      - name: Download and process assets
        run: |
          cd tools/asset-processor

          # Download assets with retry logic
          for i in {1..3}; do
            if node download-assets.js; then
              break
            fi
            echo "Download attempt $i failed, retrying..."
            sleep 30
          done

          # Process and optimize assets
          node process-assets.js

          # Validate asset integrity
          node validate-assets.js

      - name: Update asset database
        run: |
          cd backend

          # Run database migrations if needed
          npx prisma migrate deploy || true

          # Update asset metadata
          npm run asset:refresh-db || echo "Asset refresh command not available"

      - name: Generate asset manifest
        run: |
          cd tools/asset-processor
          node generate-manifest.js

      - name: Create deployment package
        run: |
          # Create a deployment archive
          tar -czf assets-$(date +%Y%m%d-%H%M%S).tar.gz \
            assets/ \
            --exclude="*.tmp" \
            --exclude="processing/*"

      - name: Upload deployment artifacts
        uses: actions/upload-artifact@v4
        with:
          name: asset-deployment-${{ github.run_number }}
          path: |
            assets-*.tar.gz
            assets/manifest.json
          retention-days: 30

      - name: Deploy to staging
        if: github.event.inputs.target_environment == 'staging' || github.event_name == 'schedule'
        run: |
          # Setup SSH key for staging deployment
          mkdir -p ~/.ssh
          echo "${{ secrets.STAGING_SSH_KEY }}" > ~/.ssh/staging_key
          chmod 600 ~/.ssh/staging_key

          # Deploy to staging
          PROD_SERVER="${{ secrets.STAGING_SERVER }}" \
          PROD_PATH="${{ secrets.STAGING_PATH }}" \
          ./scripts/sync-to-production.sh --force

      - name: Deploy to production
        if: github.event.inputs.target_environment == 'production'
        run: |
          # Setup SSH key for production deployment
          mkdir -p ~/.ssh
          echo "${{ secrets.PRODUCTION_SSH_KEY }}" > ~/.ssh/production_key
          chmod 600 ~/.ssh/production_key

          # Deploy to production
          PROD_SERVER="${{ secrets.PRODUCTION_SERVER }}" \
          PROD_PATH="${{ secrets.PRODUCTION_PATH }}" \
          ./scripts/sync-to-production.sh --force

      - name: Health check after deployment
        if: always()
        run: |
          # Wait for deployment to complete
          sleep 30

          # Check application health
          if [[ "${{ github.event.inputs.target_environment }}" == "production" ]]; then
            HEALTH_URL="${{ secrets.PRODUCTION_HEALTH_URL }}"
          else
            HEALTH_URL="${{ secrets.STAGING_HEALTH_URL }}"
          fi

          for i in {1..5}; do
            if curl -f "$HEALTH_URL/api/assets/health"; then
              echo "Health check passed"
              break
            fi
            echo "Health check attempt $i failed, retrying..."
            sleep 10
          done

      - name: Create deployment summary
        if: always()
        run: |
          cat > $GITHUB_STEP_SUMMARY << EOF
          ## Asset Update Summary

          **Date**: $(date)
          **Target**: ${{ github.event.inputs.target_environment || 'staging' }}
          **Trigger**: ${{ github.event_name }}
          **Status**: ${{ job.status }}

          ### Assets Processed
          - **Total Files**: $(find assets -type f | wc -l)
          - **Total Size**: $(du -sh assets | cut -f1)
          - **Portraits**: $(find assets/units/portraits -name "*.webp" | wc -l)
          - **Icons**: $(find assets/units/icons -name "*.webp" | wc -l)

          ### Deployment Details
          - **Artifact**: asset-deployment-${{ github.run_number }}
          - **Archive**: assets-$(date +%Y%m%d-%H%M%S).tar.gz
          - **Manifest**: Updated

          EOF

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            await github.rest.issues.create({
              owner,
              repo,
              title: 'ðŸš¨ Asset Update Failed',
              body: `
                Asset update workflow failed for ${context.workflow} run ${context.runNumber}.

                **Details:**
                - **Run**: ${context.serverUrl}/${owner}/${repo}/actions/runs/${context.runId}
                - **Target**: ${{ github.event.inputs.target_environment || 'staging' }}
                - **Trigger**: ${{ github.event_name }}
                - **Time**: ${new Date().toISOString()}

                Please investigate and manually run the asset update if needed.
              `,
              labels: ['bug', 'asset-management', 'automation']
            });

      - name: Cleanup
        if: always()
        run: |
          # Stop and remove Docker container
          docker stop swgoh-ae2-ci || true
          docker rm swgoh-ae2-ci || true

          # Clean up temporary files
          rm -rf assets-*.tar.gz
          rm -rf ~/.ssh/*_key